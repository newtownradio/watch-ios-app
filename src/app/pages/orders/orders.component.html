<div class="orders-container">
  <div class="orders-header">
    <h1>Order Management</h1>
    <p class="subtitle">
      {{ userRole === 'seller' ? 'Manage your watch sales and shipping' : 'Track your watch purchases and deliveries' }}
    </p>
    
    <!-- Testing Panel Toggle - EASILY REMOVABLE FOR PRODUCTION -->
    <div class="testing-toggle">
      <button class="testing-btn" (click)="toggleTestingPanel()">
        ğŸ§ª {{ showTestingPanel ? 'Hide' : 'Show' }} Testing Panel
      </button>
    </div>
  </div>

  <!-- Testing Panel - EASILY REMOVABLE FOR PRODUCTION -->
  <div class="testing-panel" *ngIf="showTestingPanel">
    <div class="testing-header">
      <h3>ğŸ§ª Bid & Sale Flow Testing</h3>
      <p>Test the complete transaction flows including bidding, immediate sales, shipping, and authentication</p>
    </div>

    <div class="testing-controls">
      <button class="test-btn primary" (click)="runComprehensiveTests()" [disabled]="isRunningTests">
        ğŸš€ {{ isRunningTests ? 'Running Tests...' : 'Run Comprehensive Tests' }}
      </button>
      
      <button class="test-btn" (click)="testTraditionalBiddingFlow()" [disabled]="isRunningTests">
        ğŸ·ï¸ Test Bidding Flow
      </button>
      
      <button class="test-btn" (click)="testImmediateSaleFlow()" [disabled]="isRunningTests">
        âš¡ Test Immediate Sale
      </button>
      
      <button class="test-btn" (click)="testShippingCalculator()" [disabled]="isRunningTests">
        ğŸšš Test Shipping
      </button>
      
      <button class="test-btn" (click)="testCompleteTransactionFlow()" [disabled]="isRunningTests">
        ğŸ”„ Test Complete Transaction
      </button>
      
      <button class="test-btn" (click)="testShippingFlowSuccess()" [disabled]="isRunningTests">
        ğŸ“¦ Test Shipping Success
      </button>
      
      <button class="test-btn" (click)="testShippingFlowFailure()" [disabled]="isRunningTests">
        âŒ Test Shipping Failure
      </button>
      
      <button class="test-btn" (click)="testPaymentEscrowSuccess()" [disabled]="isRunningTests">
        ğŸ’³ Test Payment Success
      </button>
      
      <button class="test-btn" (click)="testPaymentEscrowFailure()" [disabled]="isRunningTests">
        ğŸš« Test Payment Failure
      </button>
      
      <button class="test-btn" (click)="testBuyerSellerFlow()" [disabled]="isRunningTests">
        ğŸ¤ Test Buyer-Seller Flow
      </button>
    </div>

    <!-- Test Progress -->
    <div class="test-progress" *ngIf="isRunningTests">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="testProgress"></div>
      </div>
      <p class="progress-text">{{ currentTest }} - {{ testProgress }}%</p>
    </div>

    <!-- Test Results -->
    <div class="test-results" *ngIf="testResults">
      <h4>ğŸ“Š Test Results</h4>
      
      <div class="result-summary" [class]="testResults.success ? 'success' : 'error'">
        <span class="result-icon">{{ testResults.success ? 'âœ…' : 'âŒ' }}</span>
        <span class="result-text">
          {{ testResults.success ? 'All tests completed successfully!' : 'Some tests failed' }}
        </span>
      </div>

      <div class="result-details" *ngIf="testResults.error">
        <p class="error-message">âŒ Error: {{ testResults.error }}</p>
      </div>

      <div class="result-breakdown" *ngIf="testResults.success">
        <div class="breakdown-item" *ngIf="testResults.traditionalBidding">
          <span class="label">ğŸ·ï¸ Bidding Flow:</span>
          <span class="status" [class]="testResults.traditionalBidding.success ? 'success' : 'error'">
            {{ testResults.traditionalBidding.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.immediateSale">
          <span class="label">âš¡ Immediate Sale:</span>
          <span class="status" [class]="testResults.immediateSale.success ? 'success' : 'error'">
            {{ testResults.immediateSale.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.shippingCalculator">
          <span class="label">ğŸšš Shipping Calculator:</span>
          <span class="status" [class]="testResults.shippingCalculator.success ? 'success' : 'error'">
            {{ testResults.shippingCalculator.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.completeTransaction">
          <span class="label">ğŸ”„ Complete Transaction:</span>
          <span class="status" [class]="testResults.completeTransaction.success ? 'success' : 'error'">
            {{ testResults.completeTransaction.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <!-- Comprehensive Flow Tests -->
        <div class="breakdown-item" *ngIf="testResults.shippingSuccess">
          <span class="label">ğŸ“¦ Shipping Success:</span>
          <span class="status" [class]="testResults.shippingSuccess.success ? 'success' : 'error'">
            {{ testResults.shippingSuccess.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.shippingFailure">
          <span class="label">âŒ Shipping Failure:</span>
          <span class="status" [class]="testResults.shippingFailure.success ? 'success' : 'error'">
            {{ testResults.shippingFailure.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.paymentSuccess">
          <span class="label">ğŸ’³ Payment Success:</span>
          <span class="status" [class]="testResults.paymentSuccess.success ? 'success' : 'error'">
            {{ testResults.paymentSuccess.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.paymentFailure">
          <span class="label">ğŸš« Payment Failure:</span>
          <span class="status" [class]="testResults.paymentFailure.success ? 'success' : 'error'">
            {{ testResults.paymentFailure.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
        
        <div class="breakdown-item" *ngIf="testResults.buyerSellerFlow">
          <span class="label">ğŸ¤ Buyer-Seller Flow:</span>
          <span class="status" [class]="testResults.buyerSellerFlow.success ? 'success' : 'error'">
            {{ testResults.buyerSellerFlow.success ? 'âœ… Passed' : 'âŒ Failed' }}
          </span>
        </div>
      </div>

      <div class="testing-actions">
        <button class="action-btn" (click)="getTestData()">
          ğŸ“Š View Test Data
        </button>
        
        <button class="action-btn danger" (click)="clearTestData()">
          ğŸ—‘ï¸ Clear Test Data
        </button>
      </div>
    </div>
  </div>

  <!-- Orders List -->
  <div class="orders-list" *ngIf="orders.length > 0">
    <h2>Your Orders</h2>
    
    <div class="order-card" 
         *ngFor="let order of orders" 
         [class.selected]="selectedOrder?.id === order.id"
         (click)="selectOrder(order)">
      
      <div class="order-header">
        <div class="order-info">
          <h3>{{ order.watchTitle }}</h3>
          <p class="order-id">Order #{{ order.id }}</p>
          <p class="order-date">{{ order.createdAt | date:'mediumDate' }}</p>
        </div>
        
        <div class="order-status">
          <span class="status-badge" 
                [style.background-color]="getStatusColor(order.status)">
            {{ order.status.replace('_', ' ').toUpperCase() }}
          </span>
        </div>
      </div>

      <div class="order-details">
        <div class="price-info">
          <p class="final-price">${{ order.finalPrice.toLocaleString() }}</p>
          <p class="role-indicator">{{ userRole === 'seller' ? 'Sale Price' : 'Purchase Price' }}</p>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getOrderProgress(order)"></div>
        </div>

        <!-- Return Window Status -->
        <div class="return-window-status" *ngIf="order.status === 'inspection_period' || order.status === 'delivered'">
          <div class="status-info">
            <span class="status-text">{{ getReturnWindowStatus(order).status }}</span>
            <span class="time-remaining" *ngIf="getReturnWindowStatus(order).timeRemaining">
              {{ getReturnWindowStatus(order).timeRemaining }}
            </span>
          </div>
        </div>
      </div>

      <!-- Order Actions -->
      <div class="order-actions" *ngIf="selectedOrder?.id === order.id">
        <button class="action-btn payment-btn" 
                *ngIf="order.status === 'pending_payment' && userRole === 'buyer'"
                (click)="initiatePayment(order)">
          Complete Payment
        </button>
        
        <button class="action-btn" 
                *ngIf="canShowShippingCalculator(order)"
                (click)="toggleShippingCalculator()">
          {{ showShippingCalculator ? 'Hide' : 'Show' }} Shipping Calculator
        </button>
        
        <button class="action-btn" 
                *ngIf="canShowPackageTracking(order)"
                (click)="togglePackageTracking()">
          {{ showPackageTracking ? 'Hide' : 'Show' }} Package Tracking
        </button>

        <!-- Return Window Actions -->
        <button class="action-btn return-btn" 
                *ngIf="canStartReturnWindow(order)"
                (click)="startReturnWindow(order)">
          Start 72-Hour Return Window
        </button>

        <button class="action-btn return-btn" 
                *ngIf="canShowReturnActions(order)"
                (click)="toggleReturnForm()">
          {{ showReturnForm ? 'Hide' : 'Show' }} Return Actions
        </button>
      </div>

      <!-- Shipping Calculator (for sellers) -->
      <div class="shipping-section" *ngIf="selectedOrder?.id === order.id && showShippingCalculator">
        <h4>Calculate Shipping</h4>
        <app-shipping-calculator></app-shipping-calculator>
      </div>

      <!-- Package Tracking -->
      <div class="tracking-section" *ngIf="selectedOrder?.id === order.id && showPackageTracking">
        <h4>Track Package</h4>
        <app-package-tracking 
          [trackingNumber]="order.trackingNumber || ''"
          [showTrackingForm]="false">
        </app-package-tracking>
      </div>
    </div>
  </div>

  <!-- No Orders Message -->
  <div class="no-orders" *ngIf="orders.length === 0">
    <div class="empty-state">
      <h2>No Orders Yet</h2>
      <p *ngIf="userRole === 'seller'">
        You haven't sold any watches yet. Start by creating a listing in the Sell section!
      </p>
      <p *ngIf="userRole === 'buyer'">
        You haven't purchased any watches yet. Browse watches in the Discovery section!
      </p>
      <div class="action-buttons">
        <a routerLink="/sell" class="btn-primary" *ngIf="userRole === 'seller'">
          Start Selling
        </a>
        <a routerLink="/discovery" class="btn-primary" *ngIf="userRole === 'buyer'">
          Browse Watches
        </a>
      </div>
    </div>
  </div>

  <!-- Order Details Panel -->
  <div class="order-details-panel" *ngIf="selectedOrder">
    <div class="panel-header">
      <h3>Order Details</h3>
      <button class="close-btn" (click)="selectedOrder = null">Ã—</button>
    </div>
    
    <div class="details-content">
      <div class="detail-row">
        <span class="label">Watch:</span>
        <span class="value">{{ selectedOrder.watchTitle }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Status:</span>
        <span class="value">{{ selectedOrder.status.replace('_', ' ').toUpperCase() }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Price:</span>
        <span class="value">${{ selectedOrder.finalPrice.toLocaleString() }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Created:</span>
        <span class="value">{{ selectedOrder.createdAt | date:'medium' }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedOrder.trackingNumber">
        <span class="label">Tracking:</span>
        <span class="value">{{ selectedOrder.trackingNumber }}</span>
      </div>

      <!-- Return Information -->
      <div class="detail-row" *ngIf="selectedOrder.status === 'return_requested' || selectedOrder.status === 'returned'">
        <span class="label">Return Type:</span>
        <span class="value">{{ selectedOrder.returnType ? selectedOrder.returnType.replace('_', ' ').toUpperCase() : 'N/A' }}</span>
      </div>
      
      <div class="detail-row" *ngIf="selectedOrder.status === 'return_requested' || selectedOrder.status === 'returned'">
        <span class="label">Return Shipping:</span>
        <span class="value" [class.seller-pays]="getReturnShippingInfo(selectedOrder).sellerPays">
          {{ getReturnShippingInfo(selectedOrder).message }}
        </span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.status === 'returned'">
        <span class="label">Refund Amount:</span>
        <span class="value">
          ${{ orderService.calculateRefundAmount(selectedOrder.id).refundAmount.toLocaleString() }}
        </span>
      </div>
    </div>
  </div>

  <!-- Stripe Payment Form -->
  <div class="payment-section" *ngIf="showPaymentForm && selectedOrder">
    <h4>Complete Payment</h4>
    <app-stripe-payment
      [paymentTitle]="'Payment for ' + selectedOrder.watchTitle"
      [paymentAmount]="currentPaymentAmount"
      [paymentButtonText]="'Pay $' + (currentPaymentAmount / 100).toFixed(2)"
      [paymentType]="'winning_bid_payment'"
      (paymentSuccess)="onPaymentSuccess($event)"
      (paymentError)="onPaymentError($event)">
    </app-stripe-payment>
  </div>

  <!-- Return Window Form -->
  <div class="return-section" *ngIf="showReturnForm && selectedOrder">
    <h4>72-Hour Return Window</h4>
    
    <div class="return-window-info">
      <div class="return-status">
        <p><strong>Status:</strong> {{ getReturnWindowStatus(selectedOrder).status }}</p>
        <p *ngIf="getReturnWindowStatus(selectedOrder).timeRemaining">
          <strong>Time Remaining:</strong> {{ getReturnWindowStatus(selectedOrder).timeRemaining }}
        </p>
      </div>

      <div class="return-actions" *ngIf="getReturnWindowStatus(selectedOrder).canConfirm">
        <button class="btn-confirm" (click)="confirmItemReceived()">
          Confirm Item Received as Intended
        </button>
        <p class="confirm-note">
          <strong>Note:</strong> Confirming will complete the order and release funds to the seller.
        </p>
      </div>

      <div class="return-request" *ngIf="getReturnWindowStatus(selectedOrder).canReturn">
        <h5>Request Return</h5>
        
        <div class="form-group">
          <label for="return-type">Return Type:</label>
          <select id="return-type" [(ngModel)]="selectedReturnType" class="return-type-select">
            <option value="buyer_remorse">Buyer Remorse / Changed Mind</option>
            <option value="item_mismatch">Item Doesn't Match Listing</option>
            <option value="not_as_described">Not As Described</option>
            <option value="damaged_in_transit">Damaged in Transit</option>
          </select>
        </div>

        <div class="form-group">
          <label for="return-reason">Return Reason:</label>
          <textarea 
            id="return-reason"
            [(ngModel)]="returnReason"
            placeholder="Please describe why you want to return this item..."
            rows="3"
            required>
          </textarea>
        </div>

        <div class="shipping-info" *ngIf="selectedReturnType">
          <div class="shipping-note" [class.seller-pays]="selectedReturnType === 'item_mismatch' || selectedReturnType === 'not_as_described'">
            <span class="shipping-text">
              <strong *ngIf="selectedReturnType === 'item_mismatch' || selectedReturnType === 'not_as_described'">
                Seller pays return shipping ($25)
              </strong>
              <strong *ngIf="selectedReturnType === 'buyer_remorse' || selectedReturnType === 'damaged_in_transit'">
                Buyer pays return shipping ($25)
              </strong>
            </span>
          </div>
        </div>

        <button class="btn-return" (click)="requestReturn()" [disabled]="!returnReason.trim()">
          Request Return
        </button>
        <p class="return-note">
          <strong>Note:</strong> Return requests must be made within the 72-hour window.
        </p>
      </div>
    </div>
  </div>
</div>
