<div class="orders-container">
  <div class="orders-header">
    <h1>📦 Order Management</h1>
    <p class="subtitle">
      {{ userRole === 'seller' ? 'Manage your watch sales and shipping' : 'Track your watch purchases and deliveries' }}
    </p>
    
    <!-- Debug Buttons -->
    <div class="debug-buttons" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
      <h4>🔧 Debug Tools</h4>
      <button class="debug-btn" (click)="createTestOrders()" style="margin-right: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Create Test Orders
      </button>
      <button class="debug-btn" (click)="startReturnWindowForTest()" style="margin-right: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Start Return Window
      </button>
      <button class="debug-btn" (click)="loadUserOrders()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Refresh Orders
      </button>
    </div>
  </div>

  <!-- Orders List -->
  <div class="orders-list" *ngIf="orders.length > 0">
    <h2>Your Orders</h2>
    
    <div class="order-card" 
         *ngFor="let order of orders" 
         [class.selected]="selectedOrder?.id === order.id"
         (click)="selectOrder(order)">
      
      <div class="order-header">
        <div class="order-info">
          <h3>{{ order.watchTitle }}</h3>
          <p class="order-id">Order #{{ order.id }}</p>
          <p class="order-date">{{ order.createdAt | date:'mediumDate' }}</p>
        </div>
        
        <div class="order-status">
          <span class="status-badge" 
                [style.background-color]="getStatusColor(order.status)">
            {{ getStatusIcon(order.status) }} {{ order.status.replace('_', ' ').toUpperCase() }}
          </span>
        </div>
      </div>

      <div class="order-details">
        <div class="price-info">
          <p class="final-price">${{ order.finalPrice.toLocaleString() }}</p>
          <p class="role-indicator">{{ userRole === 'seller' ? 'Sale Price' : 'Purchase Price' }}</p>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getOrderProgress(order)"></div>
        </div>

        <!-- Return Window Status -->
        <div class="return-window-status" *ngIf="order.status === 'inspection_period' || order.status === 'delivered'">
          <div class="status-info">
            <span class="status-icon">⏰</span>
            <span class="status-text">{{ getReturnWindowStatus(order).status }}</span>
            <span class="time-remaining" *ngIf="getReturnWindowStatus(order).timeRemaining">
              {{ getReturnWindowStatus(order).timeRemaining }}
            </span>
          </div>
        </div>
      </div>

      <!-- Order Actions -->
      <div class="order-actions" *ngIf="selectedOrder?.id === order.id">
        <button class="action-btn payment-btn" 
                *ngIf="order.status === 'pending_payment' && userRole === 'buyer'"
                (click)="initiatePayment(order)">
          💳 Complete Payment
        </button>
        
        <button class="action-btn" 
                *ngIf="canShowShippingCalculator(order)"
                (click)="toggleShippingCalculator()">
          🚚 {{ showShippingCalculator ? 'Hide' : 'Show' }} Shipping Calculator
        </button>
        
        <button class="action-btn" 
                *ngIf="canShowPackageTracking(order)"
                (click)="togglePackageTracking()">
          📍 {{ showPackageTracking ? 'Hide' : 'Show' }} Package Tracking
        </button>

        <!-- Return Window Actions -->
        <button class="action-btn return-btn" 
                *ngIf="canStartReturnWindow(order)"
                (click)="startReturnWindow(order)">
          ⏰ Start 72-Hour Return Window
        </button>

        <button class="action-btn return-btn" 
                *ngIf="canShowReturnActions(order)"
                (click)="toggleReturnForm()">
          ⏰ {{ showReturnForm ? 'Hide' : 'Show' }} Return Actions
        </button>
      </div>

      <!-- Shipping Calculator (for sellers) -->
      <div class="shipping-section" *ngIf="selectedOrder?.id === order.id && showShippingCalculator">
        <h4>🚚 Calculate Shipping</h4>
        <app-shipping-calculator></app-shipping-calculator>
      </div>

      <!-- Package Tracking -->
      <div class="tracking-section" *ngIf="selectedOrder?.id === order.id && showPackageTracking">
        <h4>📍 Track Package</h4>
        <app-package-tracking 
          [trackingNumber]="order.trackingNumber || ''"
          [showTrackingForm]="false">
        </app-package-tracking>
      </div>
    </div>
  </div>

  <!-- No Orders Message -->
  <div class="no-orders" *ngIf="orders.length === 0">
    <div class="empty-state">
      <h2>📦 No Orders Yet</h2>
      <p *ngIf="userRole === 'seller'">
        You haven't sold any watches yet. Start by creating a listing in the Sell section!
      </p>
      <p *ngIf="userRole === 'buyer'">
        You haven't purchased any watches yet. Browse watches in the Discovery section!
      </p>
      <div class="action-buttons">
        <a routerLink="/sell" class="btn-primary" *ngIf="userRole === 'seller'">
          🚀 Start Selling
        </a>
        <a routerLink="/discovery" class="btn-primary" *ngIf="userRole === 'buyer'">
          🔍 Browse Watches
        </a>
      </div>
    </div>
  </div>

  <!-- Order Details Panel -->
  <div class="order-details-panel" *ngIf="selectedOrder">
    <div class="panel-header">
      <h3>Order Details</h3>
      <button class="close-btn" (click)="selectedOrder = null">×</button>
    </div>
    
    <div class="details-content">
      <div class="detail-row">
        <span class="label">Watch:</span>
        <span class="value">{{ selectedOrder.watchTitle }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Status:</span>
        <span class="value">{{ selectedOrder.status.replace('_', ' ').toUpperCase() }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Price:</span>
        <span class="value">${{ selectedOrder.finalPrice.toLocaleString() }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Created:</span>
        <span class="value">{{ selectedOrder.createdAt | date:'medium' }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedOrder.trackingNumber">
        <span class="label">Tracking:</span>
        <span class="value">{{ selectedOrder.trackingNumber }}</span>
      </div>

      <!-- Return Information -->
      <div class="detail-row" *ngIf="selectedOrder.status === 'return_requested' || selectedOrder.status === 'returned'">
        <span class="label">Return Type:</span>
        <span class="value">{{ selectedOrder.returnType ? selectedOrder.returnType.replace('_', ' ').toUpperCase() : 'N/A' }}</span>
      </div>
      
      <div class="detail-row" *ngIf="selectedOrder.status === 'return_requested' || selectedOrder.status === 'returned'">
        <span class="label">Return Shipping:</span>
        <span class="value" [class.seller-pays]="getReturnShippingInfo(selectedOrder).sellerPays">
          {{ getReturnShippingInfo(selectedOrder).message }}
        </span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.status === 'returned'">
        <span class="label">Refund Amount:</span>
        <span class="value">
          ${{ orderService.calculateRefundAmount(selectedOrder.id).refundAmount.toLocaleString() }}
        </span>
      </div>
    </div>
  </div>

  <!-- Stripe Payment Form -->
  <div class="payment-section" *ngIf="showPaymentForm && selectedOrder">
    <h4>💳 Complete Payment</h4>
    <app-stripe-payment
      [paymentTitle]="'Payment for ' + selectedOrder.watchTitle"
      [paymentAmount]="currentPaymentAmount"
      [paymentButtonText]="'Pay $' + (currentPaymentAmount / 100).toFixed(2)"
      [paymentType]="'winning_bid_payment'"
      (paymentSuccess)="onPaymentSuccess($event)"
      (paymentError)="onPaymentError($event)">
    </app-stripe-payment>
  </div>

  <!-- Return Window Form -->
  <div class="return-section" *ngIf="showReturnForm && selectedOrder">
    <h4>⏰ 72-Hour Return Window</h4>
    
    <div class="return-window-info">
      <div class="return-status">
        <p><strong>Status:</strong> {{ getReturnWindowStatus(selectedOrder).status }}</p>
        <p *ngIf="getReturnWindowStatus(selectedOrder).timeRemaining">
          <strong>Time Remaining:</strong> {{ getReturnWindowStatus(selectedOrder).timeRemaining }}
        </p>
      </div>

      <div class="return-actions" *ngIf="getReturnWindowStatus(selectedOrder).canConfirm">
        <button class="btn-confirm" (click)="confirmItemReceived()">
          ✅ Confirm Item Received as Intended
        </button>
        <p class="confirm-note">
          <strong>Note:</strong> Confirming will complete the order and release funds to the seller.
        </p>
      </div>

      <div class="return-request" *ngIf="getReturnWindowStatus(selectedOrder).canReturn">
        <h5>Request Return</h5>
        
        <div class="form-group">
          <label for="return-type">Return Type:</label>
          <select id="return-type" [(ngModel)]="selectedReturnType" class="return-type-select">
            <option value="buyer_remorse">Buyer Remorse / Changed Mind</option>
            <option value="item_mismatch">Item Doesn't Match Listing</option>
            <option value="not_as_described">Not As Described</option>
            <option value="damaged_in_transit">Damaged in Transit</option>
          </select>
        </div>

        <div class="form-group">
          <label for="return-reason">Return Reason:</label>
          <textarea 
            id="return-reason"
            [(ngModel)]="returnReason"
            placeholder="Please describe why you want to return this item..."
            rows="3"
            required>
          </textarea>
        </div>

        <div class="shipping-info" *ngIf="selectedReturnType">
          <div class="shipping-note" [class.seller-pays]="selectedReturnType === 'item_mismatch' || selectedReturnType === 'not_as_described'">
            <span class="shipping-icon">🚚</span>
            <span class="shipping-text">
              <strong *ngIf="selectedReturnType === 'item_mismatch' || selectedReturnType === 'not_as_described'">
                ✅ Seller pays return shipping ($$25)
              </strong>
              <strong *ngIf="selectedReturnType === 'buyer_remorse' || selectedReturnType === 'damaged_in_transit'">
                💳 Buyer pays return shipping ($$25)
              </strong>
            </span>
          </div>
        </div>

        <button class="btn-return" (click)="requestReturn()" [disabled]="!returnReason.trim()">
          ↩️ Request Return
        </button>
        <p class="return-note">
          <strong>Note:</strong> Return requests must be made within the 72-hour window.
        </p>
      </div>
    </div>
  </div>
</div>
