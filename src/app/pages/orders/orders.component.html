<div class="orders-container">
  <div class="orders-header">
    <h1>Order Management</h1>
    <p class="subtitle">
      {{ userRole === 'seller' ? 'Manage your watch sales and shipping' : 'Track your watch purchases and deliveries' }}
    </p>
  </div>

  <!-- Order Flow Diagram -->
  <div class="order-flow-diagram">
    <h3>How Orders Work</h3>
    <div class="flow-timeline">
      <div class="flow-stage">
        <div class="stage-text">Order Created</div>
      </div>
      
      <div class="flow-line"></div>
      
      <div class="flow-stage">
        <div class="stage-text">Payment</div>
      </div>
      
      <div class="flow-line"></div>
      
      <div class="flow-stage">
        <div class="stage-text">Shipped</div>
      </div>
      
      <div class="flow-line"></div>
      
      <div class="flow-stage">
        <div class="stage-text">Authentication</div>
      </div>
      
      <div class="flow-line"></div>
      
      <div class="flow-stage">
        <div class="stage-text">Delivered</div>
      </div>
      
      <div class="flow-line"></div>
      
      <div class="flow-stage">
        <div class="stage-text">Complete</div>
      </div>
    </div>
    
    <div class="flow-description">
      <p><strong>72-Hour Return Window:</strong> After delivery, you have 3 days to inspect your item and request a return if needed.</p>
    </div>
  </div>

  <!-- Orders List -->
  <div class="orders-list" *ngIf="orders.length > 0">
    <h2>Your Orders</h2>
    
    <div class="order-card" 
         *ngFor="let order of orders" 
         [class.selected]="selectedOrder?.id === order.id"
         (click)="selectOrder(order)">
      
      <div class="order-header">
        <div class="order-info">
          <h3>{{ order.watchTitle }}</h3>
          <p class="order-id">Order #{{ order.id }}</p>
          <p class="order-date">{{ order.createdAt | date:'mediumDate' }}</p>
        </div>
        
        <div class="order-status">
          <span class="status-badge" 
                [style.background-color]="getStatusColor(order.status)">
            {{ order.status.replace('_', ' ').toUpperCase() }}
          </span>
        </div>
        
        <!-- Stage Indicator -->
        <div class="stage-indicator">
          <span class="stage-number">{{ getOrderStageNumber(order) }}</span>
          <span class="stage-label">Stage {{ getOrderStageNumber(order) }}</span>
        </div>
      </div>

      <div class="order-details">
        <div class="price-info">
          <p class="final-price">${{ order.finalPrice.toLocaleString() }}</p>
          <p class="role-indicator">{{ userRole === 'seller' ? 'Sale Price' : 'Purchase Price' }}</p>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getOrderProgress(order)"></div>
        </div>

        <!-- Return Window Status -->
        <div class="return-window-status" *ngIf="order.status === 'inspection_period' || order.status === 'delivered'">
          <div class="status-info">
            <span class="status-text">{{ getReturnWindowStatus(order).status }}</span>
            <span class="time-remaining" *ngIf="getReturnWindowStatus(order).timeRemaining">
              {{ getReturnWindowStatus(order).timeRemaining }}
            </span>
          </div>
        </div>
      </div>

      <!-- Order Actions -->
      <div class="order-actions" *ngIf="selectedOrder?.id === order.id">
        <!-- Payment Actions for Buyers -->
        <button class="action-btn payment-btn" 
                *ngIf="canShowPaymentForm(order)"
                (click)="togglePaymentForm()">
          {{ showPaymentForm ? 'Cancel Payment' : 'Complete Payment' }}
        </button>
        
        <!-- Shipping Actions for Sellers -->
        <button class="action-btn shipping-btn" 
                *ngIf="canShowShippingForm(order)"
                (click)="toggleShippingForm()">
          {{ showShippingForm ? 'Cancel Shipping' : 'Update Shipping' }}
        </button>

        <!-- Return Actions for Buyers -->
        <button class="action-btn return-btn" 
                *ngIf="canStartReturn(order)"
                (click)="toggleReturnForm()">
          {{ showReturnForm ? 'Hide' : 'Show' }} Return Actions
        </button>

        <!-- Return Window Expired Message -->
        <div class="return-window-expired" *ngIf="!canStartReturn(order) && order.status === 'delivered' && order.deliveredAt">
          <div class="expired-message">
            <span class="expired-icon">⏰</span>
            <span class="expired-text">
              <strong>Return Window Expired:</strong> The 72-hour return period has ended. 
              For special circumstances, please <a href="mailto:customer-service@watch.style">contact customer service</a>.
            </span>
          </div>
        </div>
      </div>

      <!-- Shipping Form (for sellers) -->
      <div class="shipping-section" *ngIf="selectedOrder?.id === order.id && showShippingForm">
        <h4>Update Shipping Information</h4>
        <div class="shipping-form">
          <div class="form-group">
            <label for="tracking-number">Tracking Number:</label>
            <input 
              type="text" 
              id="tracking-number"
              [(ngModel)]="shippingForm.trackingNumber"
              placeholder="Enter tracking number"
              required>
          </div>
          
          <div class="form-group">
            <label for="carrier">Shipping Carrier:</label>
            <select id="carrier" [(ngModel)]="shippingForm.carrier" required>
              <option value="">Select carrier</option>
              <option value="FedEx">FedEx</option>
              <option value="UPS">UPS</option>
              <option value="USPS">USPS</option>
              <option value="DHL">DHL</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="estimated-delivery">Estimated Delivery:</label>
            <input 
              type="date" 
              id="estimated-delivery"
              [(ngModel)]="shippingForm.estimatedDelivery">
          </div>
          
          <div class="form-group">
            <label for="shipping-notes">Notes:</label>
            <textarea 
              id="shipping-notes"
              [(ngModel)]="shippingForm.notes"
              placeholder="Optional shipping notes..."
              rows="2">
            </textarea>
          </div>
          
          <div class="form-actions">
            <button class="btn-primary" (click)="updateShippingInfo(order)" 
                    [disabled]="!shippingForm.trackingNumber || !shippingForm.carrier">
              Update Shipping
            </button>
            <button class="btn-secondary" (click)="toggleShippingForm()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Return Form (for buyers) -->
      <div class="return-section" *ngIf="selectedOrder?.id === order.id && showReturnForm">
        <h4>Return Request</h4>
        
        <div class="return-form">
          <div class="form-group">
            <label for="return-type">Return Type:</label>
            <select id="return-type" [(ngModel)]="selectedReturnType" class="return-type-select">
              <option value="buyer_remorse">Buyer Remorse / Changed Mind</option>
              <option value="item_mismatch">Item Doesn't Match Listing</option>
              <option value="not_as_described">Not As Described</option>
              <option value="damaged_in_transit">Damaged in Transit</option>
            </select>
          </div>

          <div class="form-group">
            <label for="return-reason">Return Reason:</label>
            <textarea 
              id="return-reason"
              [(ngModel)]="returnReason"
              placeholder="Please describe why you want to return this item..."
              rows="3"
              required>
            </textarea>
          </div>

          <div class="shipping-info" *ngIf="selectedReturnType">
            <div class="shipping-note" [class.seller-pays]="getReturnShippingInfo(order).sellerPays">
              <span class="shipping-text">
                {{ getReturnShippingInfo(order).message }}
              </span>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-primary" (click)="submitReturnRequest()" [disabled]="!returnReason.trim()">
              Submit Return Request
            </button>
            <button class="btn-secondary" (click)="toggleReturnForm()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Orders Message -->
  <div class="no-orders" *ngIf="orders.length === 0">
    <div class="empty-state">
      <h2>No Orders Yet</h2>
      <p *ngIf="userRole === 'seller'">
        You haven't sold any watches yet. Start by creating a listing in the Sell section!
      </p>
      <p *ngIf="userRole === 'buyer'">
        You haven't purchased any watches yet. Browse watches in the Discovery section!
      </p>
      <div class="action-buttons">
        <a routerLink="/sell" class="btn-primary" *ngIf="userRole === 'seller'">
          Start Selling
        </a>
        <a routerLink="/discovery" class="btn-primary" *ngIf="userRole === 'buyer'">
          Browse Watches
        </a>
      </div>
    </div>
  </div>

  <!-- Order Details Panel -->
  <div class="order-details-panel" *ngIf="selectedOrder">
    <div class="panel-header">
      <h3>Order Details</h3>
      <button class="close-btn" (click)="selectedOrder = null">×</button>
    </div>
    
    <div class="details-content">
      <div class="detail-row">
        <span class="label">Watch:</span>
        <span class="value">{{ selectedOrder.watchTitle }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Brand:</span>
        <span class="value">{{ selectedOrder.watchBrand }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Model:</span>
        <span class="value">{{ selectedOrder.watchModel }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Status:</span>
        <span class="value status-value" [style.color]="getStatusColor(selectedOrder.status)">
          {{ selectedOrder.status.replace('_', ' ').toUpperCase() }}
        </span>
      </div>
      <div class="detail-row">
        <span class="label">Price:</span>
        <span class="value">${{ selectedOrder.finalPrice.toLocaleString() }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Created:</span>
        <span class="value">{{ selectedOrder.createdAt | date:'medium' }}</span>
      </div>
      
      <!-- Payment Information -->
      <div class="detail-row" *ngIf="selectedOrder.paymentConfirmedAt">
        <span class="label">Payment Date:</span>
        <span class="value">{{ selectedOrder.paymentConfirmedAt | date:'medium' }}</span>
      </div>

      <!-- Shipping Information -->
      <div class="detail-row" *ngIf="selectedOrder.trackingNumber">
        <span class="label">Tracking Number:</span>
        <span class="value">{{ selectedOrder.trackingNumber }}</span>
      </div>
      
      <div class="detail-row" *ngIf="selectedOrder.shippingCarrier">
        <span class="label">Shipping Carrier:</span>
        <span class="value">{{ selectedOrder.shippingCarrier }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.shippedAt">
        <span class="label">Shipped Date:</span>
        <span class="value">{{ selectedOrder.shippedAt | date:'medium' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.estimatedDeliveryDate">
        <span class="label">Estimated Delivery:</span>
        <span class="value">{{ selectedOrder.estimatedDeliveryDate | date:'mediumDate' }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.deliveredAt">
        <span class="label">Delivered Date:</span>
        <span class="value">{{ selectedOrder.deliveredAt | date:'medium' }}</span>
      </div>

      <!-- Return Information -->
      <div class="detail-row" *ngIf="selectedOrder.returnRequestedAt">
        <span class="label">Return Requested:</span>
        <span class="value">{{ selectedOrder.returnRequestedAt | date:'medium' }}</span>
      </div>
      
      <div class="detail-row" *ngIf="selectedOrder.returnType">
        <span class="label">Return Type:</span>
        <span class="value">{{ selectedOrder.returnType.replace('_', ' ').toUpperCase() }}</span>
      </div>
      
      <div class="detail-row" *ngIf="selectedOrder.returnReason">
        <span class="label">Return Reason:</span>
        <span class="value">{{ selectedOrder.returnReason }}</span>
      </div>

      <div class="detail-row" *ngIf="selectedOrder.returnShippingPaidBy">
        <span class="label">Return Shipping:</span>
        <span class="value" [class.seller-pays]="selectedOrder.returnShippingPaidBy === 'seller'">
          {{ selectedOrder.returnShippingPaidBy === 'seller' ? 'Seller pays return shipping' : 'Buyer pays return shipping' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Payment Form -->
  <div class="payment-section" *ngIf="showPaymentForm && selectedOrder">
    <div class="payment-overlay">
      <div class="payment-modal">
        <div class="modal-header">
          <h4>Complete Payment</h4>
          <button class="close-btn" (click)="togglePaymentForm()">×</button>
        </div>
        
        <div class="payment-content">
          <div class="payment-summary">
            <h5>Payment Summary</h5>
            <div class="summary-row">
              <span>Watch:</span>
              <span>{{ selectedOrder.watchTitle }}</span>
            </div>
            <div class="summary-row">
              <span>Amount:</span>
              <span>${{ (currentPaymentAmount / 100).toFixed(2) }}</span>
            </div>
          </div>
          
          <div class="payment-form">
            <div class="form-group">
              <label for="card-number">Card Number:</label>
              <input 
                type="text" 
                id="card-number"
                [(ngModel)]="paymentForm.cardNumber"
                placeholder="1234 5678 9012 3456"
                maxlength="19"
                required>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="expiry-date">Expiry Date:</label>
                <input 
                  type="text" 
                  id="expiry-date"
                  [(ngModel)]="paymentForm.expiryDate"
                  placeholder="MM/YY"
                  maxlength="5"
                  required>
              </div>
              
              <div class="form-group">
                <label for="cvv">CVV:</label>
                <input 
                  type="text" 
                  id="cvv"
                  [(ngModel)]="paymentForm.cvv"
                  placeholder="123"
                  maxlength="4"
                  required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="cardholder-name">Cardholder Name:</label>
              <input 
                type="text" 
                id="cardholder-name"
                [(ngModel)]="paymentForm.cardholderName"
                placeholder="John Doe"
                required>
            </div>
            
            <div class="form-group">
              <label for="billing-street">Billing Address:</label>
              <input 
                type="text" 
                id="billing-street"
                [(ngModel)]="paymentForm.billingAddress.street"
                placeholder="123 Main Street"
                required>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="billing-city">City:</label>
                <input 
                  type="text" 
                  id="billing-city"
                  [(ngModel)]="paymentForm.billingAddress.city"
                  placeholder="New York"
                  required>
              </div>
              
              <div class="form-group">
                <label for="billing-state">State:</label>
                <input 
                  type="text" 
                  id="billing-state"
                  [(ngModel)]="paymentForm.billingAddress.state"
                  placeholder="NY"
                  required>
              </div>
              
              <div class="form-group">
                <label for="billing-zip">ZIP Code:</label>
                <input 
                  type="text" 
                  id="billing-zip"
                  [(ngModel)]="paymentForm.billingAddress.zipCode"
                  placeholder="10001"
                  required>
              </div>
            </div>
            
            <div class="form-actions">
              <button class="btn-primary" (click)="initiatePayment(selectedOrder)" 
                      [disabled]="!paymentForm.cardNumber || !paymentForm.expiryDate || !paymentForm.cvv || !paymentForm.cardholderName">
                Pay ${{ (currentPaymentAmount / 100).toFixed(2) }}
              </button>
              <button class="btn-secondary" (click)="togglePaymentForm()">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- In-App Notification -->
  <div class="notification" *ngIf="currentNotification">
    <div class="notification-content" [class]="'notification-' + currentNotification.type">
      <span class="notification-title">{{ currentNotification.title }}</span>
      <span class="notification-message">{{ currentNotification.message }}</span>
      <button 
        class="notification-close" 
        (click)="currentNotification = null"
        (keydown.enter)="currentNotification = null"
        (keydown.space)="currentNotification = null"
        tabindex="0"
        aria-label="Close notification">
        ×
      </button>
    </div>
  </div>
</div>
