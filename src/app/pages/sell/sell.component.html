<div class="sell-page">
  <div class="page-header">
    <h1>Sell</h1>
    <p>List your item for sale</p>
  </div>

  <div class="sell-form">
    <!-- Watch Type Selection -->
    <div class="form-group watch-type-selection">
      <label for="watch-type">Watch Type *</label>
      <select [(ngModel)]="form.watchType" id="watch-type" required>
        <option value="">Select Watch Type</option>
        <option value="analog">Analog/Mechanical Watch</option>
        <option value="digital">Digital/Smartwatch</option>
        <option value="apple-watch">Apple Watch</option>
      </select>
      <small class="form-help">Choose the type of watch you're selling</small>
    </div>

    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" [(ngModel)]="form.title" placeholder="e.g., Rolex Submariner" id="title">
    </div>

    <div class="form-group">
      <label for="product-image">Product Image</label>
      <div class="image-upload-container">
        <div class="image-preview" *ngIf="form.imageUrl">
          <img [src]="form.imageUrl" alt="Product preview" class="preview-image">
          <button type="button" class="remove-image-btn" (click)="removeImage()">×</button>
        </div>
        <div class="upload-area" *ngIf="!form.imageUrl" 
             (click)="triggerFileInput()" 
             (keydown.enter)="triggerFileInput()" 
             (keydown.space)="triggerFileInput()"
             tabindex="0"
             role="button"
             aria-label="Upload product image">
          <div class="upload-content">
            <span class="upload-icon">Photo</span>
            <p>Click to upload a photo of your watch</p>
            <small>JPG or PNG up to 5MB</small>
          </div>
        </div>
        <input 
          type="file" 
          #fileInput
          (change)="onFileSelected($event)"
          accept="image/jpeg,image/jpg,image/png"
          style="display: none;"
          id="product-image">
      </div>
      <small class="form-help">Upload a clear photo of your watch for better visibility</small>
    </div>

    <!-- Government ID Upload -->
    <div class="form-group">
      <label for="government-id">Government ID Upload (Required for Listing)</label>
      <div class="id-upload-container">
        <div class="id-preview" *ngIf="form.governmentIdUrl">
          <img [src]="form.governmentIdUrl" alt="Government ID" class="id-image">
          <button type="button" class="remove-id-btn" (click)="removeGovernmentId()">×</button>
        </div>
        <div class="id-upload-area" *ngIf="!form.governmentIdUrl" 
             (click)="triggerGovernmentIdInput()" 
             (keydown.enter)="triggerGovernmentIdInput()" 
             (keydown.space)="triggerGovernmentIdInput()"
             tabindex="0"
             role="button"
             aria-label="Upload government ID">
          <div class="upload-content">
            <span class="upload-icon">ID</span>
            <p>Click to upload your government ID</p>
            <small>JPG or PNG, max 5MB</small>
          </div>
        </div>
        <input 
          type="file" 
          id="government-id"
          accept="image/jpeg,image/jpg,image/png"
          (change)="onGovernmentIdSelected($event)"
          style="display: none;"
        >
      </div>
      <small class="form-help">
        <strong>Legal Compliance Required:</strong> Government ID upload is mandatory for legal compliance and fraud prevention. 
        You must upload your own government-issued ID (driver's license, passport, or state ID). 
        The name on the ID must match your account information. Using someone else's ID is prohibited and may result in account suspension.
        <br><br>
        <strong>Privacy Protection:</strong> Your ID information is encrypted and stored securely. It is never shared publicly 
        and is only used for verification purposes by our security team.
      </small>
    </div>

    <!-- AI Pricing Assistant Section -->
    <div class="pricing-assistant">
      <h3>AI Pricing Assistant</h3>
      <p>Get accurate pricing based on market data and similar items</p>
      
      <!-- Simple Debug -->
      <div style="background: #f0f0f0; padding: 5px; margin: 5px 0; font-size: 10px;">
        Brands: {{ availableBrands.length }} | Models: {{ availableModels.length }}
      </div>
      
      <div class="pricing-form">
        <div class="form-row">
          <div class="form-group">
            <label for="brand">Brand *</label>
            <select [(ngModel)]="form.brand" (change)="onBrandChange()" id="brand" required>
              <option value="">Select Brand</option>
              <option *ngFor="let brand of availableBrands" [value]="brand">
                {{ brand }}
              </option>
            </select>
            <small class="form-help">Choose the watch brand for accurate pricing</small>
          </div>
          
          <div class="form-group">
            <label for="model">Model *</label>
            <select [(ngModel)]="form.model" id="model" [disabled]="!form.brand" required>
              <option value="">Select Model</option>
              <option *ngFor="let model of availableModels" [value]="model">
                {{ model }}
              </option>
            </select>
            <small class="form-help" *ngIf="!form.brand">Select a brand first</small>
            <small class="form-help" *ngIf="form.brand">{{ getModelCount() }} models available</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="year">Year (Optional)</label>
            <input type="number" [(ngModel)]="form.year" placeholder="e.g., 2020" id="year" min="1900" max="2024">
            <small class="form-help">Year of manufacture for more accurate pricing</small>
          </div>
          
          <div class="form-group">
            <label for="condition">Condition *</label>
            <select [(ngModel)]="form.condition" id="condition" required>
              <option value="excellent">Excellent - Like new</option>
              <option value="very-good">Very Good - Minor wear</option>
              <option value="good">Good - Some wear</option>
              <option value="fair">Fair - Significant wear</option>
            </select>
            <small class="form-help">Condition affects pricing significantly</small>
          </div>
        </div>

        <div class="form-group">
          <label for="original-price">Original Price (Optional)</label>
          <input type="number" [(ngModel)]="form.originalPrice" placeholder="What you paid originally" id="original-price" min="0">
          <small class="form-help">Helps AI provide more accurate pricing</small>
        </div>

        <button class="pricing-btn" (click)="getPricingRecommendation()" type="button" [disabled]="!form.brand || !form.model">
          Get AI Pricing Recommendation
        </button>
        <div class="ai-disclaimer">
          <small class="disclaimer-text">
            ⚠️ AI pricing is a prediction based on market data and may not be perfectly accurate for all watches. 
            Use as a reference point and consider professional appraisal for high-value items.
          </small>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="starting-price">Starting Price</label>
      <input type="number" [(ngModel)]="form.startingPrice" placeholder="0" id="starting-price" min="0">
      <small class="form-help">This is the minimum bid amount</small>
    </div>



    <div class="form-group">
      <label for="description">Description</label>
      <textarea [(ngModel)]="form.description" placeholder="Describe your item..." id="description"></textarea>
    </div>

    <!-- Authentication Partners Section -->
    <div class="authentication-section">
      <h3>Authentication Partner Selection</h3>
      <p class="section-description">Choose a professional authentication service for your watch. This ensures buyers can trust the authenticity of your item.</p>
      
      <app-authentication-partners
        [selectedPartnerId]="form.authenticationPartner"
        [watchBrand]="form.brand"
        [watchModel]="form.model"
        [estimatedValue]="form.startingPrice"
        [userCountry]="userCountry"
        [showRecommended]="true"
        (partnerSelected)="onAuthenticationPartnerChange($event)"
        (partnerChanged)="onAuthenticationPartnerChange($event)">
      </app-authentication-partners>
    </div>

    <!-- Sale Options -->
    <div class="sale-options">
      <h3>Sale Options</h3>
      <p>Choose how you want to sell your item</p>
      
      <div class="sale-option">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="form.allowBidding" id="allow-bidding">
          <span class="checkmark"></span>
          Allow Bidding
        </label>
        <small class="form-help">Enable traditional bidding with a 3-month sale window</small>
      </div>
      
      <div class="sale-option">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="form.allowInstantSale" id="allow-instant-sale">
          <span class="checkmark"></span>
          Allow Instant Sale
        </label>
        <small class="form-help">Enable immediate purchase at a set price</small>
        
        <div class="instant-sale-price" *ngIf="form.allowInstantSale">
          <label for="instant-sale-price">Instant Sale Price *</label>
          <input 
            type="number" 
            [(ngModel)]="form.instantSalePrice" 
            id="instant-sale-price" 
            placeholder="Enter price for immediate purchase"
            min="0"
            required>
          <small class="form-help">Recommended: 20-30% above your starting price for convenience</small>
        </div>
      </div>
    </div>

    <!-- Schedule Listing Section -->
    <div class="form-group">
      <label for="schedule-listing">Schedule Listing</label>
      <div class="schedule-options">
        <div class="schedule-option">
          <input type="radio" [(ngModel)]="form.scheduleType" value="immediate" id="immediate" name="schedule">
          <label for="immediate">List immediately</label>
        </div>
        <div class="schedule-option">
          <input type="radio" [(ngModel)]="form.scheduleType" value="scheduled" id="scheduled" name="schedule">
          <label for="scheduled">Schedule for later</label>
        </div>
      </div>
      
      <div class="schedule-datetime" *ngIf="form.scheduleType === 'scheduled'">
        <div class="form-row">
          <div class="form-group">
            <label for="schedule-date">Date</label>
            <input type="date" [(ngModel)]="form.scheduleDate" id="schedule-date" [min]="getMinDate()">
          </div>
          <div class="form-group">
            <label for="schedule-time">Time</label>
            <input type="time" [(ngModel)]="form.scheduleTime" id="schedule-time">
          </div>
        </div>
        <small class="form-help">Your listing will go live at the scheduled date and time</small>
      </div>
    </div>

    <!-- Final List Button -->
    <div class="final-actions">
      <button class="list-btn" (click)="submitForm()" type="button">
        List Item for Sale
      </button>
    </div>
  </div>

  <!-- Pricing Recommendation Modal -->
  <div class="pricing-modal" *ngIf="showPricingAssistant">
    <div class="modal-content">
      <div class="modal-header">
        <h3>AI Pricing Recommendation</h3>
        <button class="close-btn" (click)="closePricingAssistant()">×</button>
      </div>
      
      <div class="pricing-details" *ngIf="pricingRecommendation">
        <div class="price-highlight">
          <h4>Suggested Price</h4>
          <div class="suggested-price">${{ pricingRecommendation.suggestedPrice.toLocaleString() }}</div>
          <div class="confidence">Confidence: {{ (pricingRecommendation.confidence * 100).toFixed(0) }}%</div>
        </div>

        <div class="market-insights">
          <h4>Market Insights</h4>
          <div class="insight-item">
            <span class="label">Brand:</span>
            <span class="value">{{ pricingRecommendation.marketInsights.brand }} {{ pricingRecommendation.marketInsights.model }}</span>
          </div>
          <div class="insight-item">
            <span class="label">Market Trend:</span>
            <span class="value trend-{{ pricingRecommendation.marketInsights.marketTrend }}">
              {{ pricingRecommendation.marketInsights.marketTrend }}
            </span>
          </div>
          <div class="insight-item">
            <span class="label">Demand Level:</span>
            <span class="value demand-{{ pricingRecommendation.marketInsights.demandLevel }}">
              {{ pricingRecommendation.marketInsights.demandLevel }}
            </span>
          </div>
          <div class="insight-item">
            <span class="label">Recent Sales:</span>
            <span class="value">{{ pricingRecommendation.marketInsights.recentSales }} similar watches</span>
          </div>
          <div class="insight-item">
            <span class="label">Avg Days on Market:</span>
            <span class="value">{{ pricingRecommendation.marketInsights.daysOnMarket }} days</span>
          </div>
        </div>

        <div class="price-factors">
          <h4>Price Factors</h4>
          <div class="factor-item">
            <span class="label">Condition Multiplier:</span>
            <span class="value">{{ (pricingRecommendation.priceFactors.conditionMultiplier * 100).toFixed(0) }}%</span>
          </div>
          <div class="factor-item">
            <span class="label">Brand Value:</span>
            <span class="value">{{ (pricingRecommendation.priceFactors.brandValue * 100).toFixed(0) }}%</span>
          </div>
          <div class="factor-item">
            <span class="label">Market Demand:</span>
            <span class="value">{{ (pricingRecommendation.priceFactors.marketDemand * 100).toFixed(0) }}%</span>
          </div>
          <div class="factor-item">
            <span class="label">Seasonal Adjustment:</span>
            <span class="value">{{ (pricingRecommendation.priceFactors.seasonalAdjustment * 100).toFixed(0) }}%</span>
          </div>
        </div>

        <div class="reasoning">
          <h4>AI Reasoning</h4>
          <ul class="reasoning-list">
            <li *ngFor="let reason of pricingRecommendation.reasoning">{{ reason }}</li>
          </ul>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="closePricingAssistant()">Cancel</button>
        <button class="apply-btn" (click)="applyPricingRecommendation()">Apply Suggested Price</button>
      </div>
    </div>
  </div>

  <!-- Counteroffer Form Modal -->
  <div class="counteroffer-modal" *ngIf="showCounterofferForm">
    <div class="modal-content">
      <h3>Make Counteroffer</h3>
              <p>You can make 3 counteroffers per listing. Buyer has 3 months to respond.</p>
      
      <div class="form-group">
        <label for="counteroffer-amount">Counteroffer Amount</label>
        <input type="number" [(ngModel)]="counterofferForm.amount" placeholder="0" id="counteroffer-amount">
      </div>
      
      <div class="form-group">
        <label for="counteroffer-message">Message (Optional)</label>
        <textarea [(ngModel)]="counterofferForm.message" placeholder="Add a message to the buyer..." id="counteroffer-message"></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="cancel-btn" (click)="cancelCounteroffer()">Cancel</button>
        <button class="submit-btn" (click)="submitCounteroffer()">Send Counteroffer</button>
      </div>
    </div>
  </div>





  <!-- Active Listings Section -->
  <div class="active-listings" *ngIf="activeListings.length > 0">
    <h2>Your Active Listings</h2>
    
    <div class="listing-card" *ngFor="let listing of activeListings">
      <div class="listing-header">
        <h3>{{ listing.title }}</h3>
        <div class="header-actions">
          <span class="status" [class]="listing.status">{{ listing.status }}</span>
          <button class="share-btn" (click)="shareListing(listing)" title="Share this listing">
            📤 Share
          </button>
          <button class="delete-btn" (click)="deleteListing(listing.id)" title="Delete listing">
            🗑️
          </button>
        </div>
      </div>
      
      <div class="listing-details">
        <p class="description">{{ listing.description }}</p>
        <p class="price">Starting: ${{ listing.startingPrice.toLocaleString() }}</p>
        <p class="current-price" *ngIf="listing.highestBid">
          Highest Bid: ${{ listing.highestBid.amount.toLocaleString() }}
        </p>
      </div>

      <div class="sale-window">
        <div class="time-info">
          <p class="start-time">
            <strong>Listed:</strong> {{ getListingStartTime(listing.createdAt) }}
          </p>
          <p class="end-time">
            <strong>Ends:</strong> {{ getListingEndTime(listing.endTime) }}
          </p>
          <p class="time-remaining">
            <strong>Time Remaining:</strong> {{ getTimeRemaining(listing.endTime) }}
          </p>
        </div>
        <p class="bid-count">
          <strong>Bids Received:</strong> {{ listing.bids.length }}
        </p>
        <p class="counteroffer-status" *ngIf="listing.counterofferCount && listing.counterofferCount > 0">
          <strong>Counteroffers Made:</strong> {{ listing.counterofferCount }}/3 used
        </p>
      </div>

      <!-- Pending Bids Section -->
      <div class="pending-bids" *ngIf="hasPendingBids(listing)">
        <h4>Pending Bids</h4>
        <div class="bid-item" *ngFor="let bid of getPendingBids(listing)">
          <div class="bid-details">
            <p><strong>Bidder:</strong> {{ bid.bidderName }}</p>
            <p><strong>Amount:</strong> ${{ bid.amount.toLocaleString() }}</p>
            <p><strong>Time:</strong> {{ bid.timestamp | date:'short' }}</p>
          </div>
          
          <div class="bid-actions">
            <button class="accept-btn" (click)="acceptBid(listing.id, bid.id)">
              Accept
            </button>
            <button class="decline-btn" (click)="declineBid(listing.id, bid.id)">
              Decline
            </button>
            <button class="counteroffer-btn" 
                    (click)="makeCounteroffer(listing.id, bid.id)"
                    *ngIf="(listing.counterofferCount || 0) < 3">
              Make Counteroffer
            </button>
          </div>
        </div>
      </div>

      <!-- Counteroffers Section -->
      <div class="counteroffers" *ngIf="getPendingCounteroffers(listing).length > 0">
        <h4>Pending Counteroffers</h4>
        <div class="counteroffer-item" *ngFor="let counteroffer of getPendingCounteroffers(listing)">
          <div class="counteroffer-details">
            <p><strong>Your Counteroffer:</strong> ${{ counteroffer.amount.toLocaleString() }}</p>
            <p><strong>Sent:</strong> {{ counteroffer.timestamp | date:'short' }}</p>
            <p *ngIf="counteroffer.message"><strong>Message:</strong> {{ counteroffer.message }}</p>
            <p class="status">Waiting for buyer response...</p>
          </div>
        </div>
      </div>

      <!-- Expired Notice -->
      <div class="expired-notice" *ngIf="listing.status === 'expired'">
        <p>Sale window expired. No bids were accepted.</p>
      </div>

      <!-- Sold Notice -->
      <div class="sold-notice" *ngIf="listing.status === 'sold' && listing.highestBid">
        <p>Item sold to {{ listing.highestBid.bidderName }} for ${{ listing.highestBid.amount.toLocaleString() }}</p>
        <p>Smart contract created. Shipping costs will be split.</p>
      </div>
    </div>
  </div>

  <!-- Multi-Step Bid Acceptance Flow -->
  <div class="bid-acceptance-flow" *ngIf="showBidAcceptanceFlow">
    <div class="flow-overlay">
      <div class="flow-container">
        <div class="flow-header">
          <h2>🚀 Accept Bid & Create Order</h2>
          <button class="close-flow-btn" (click)="showBidAcceptanceFlow = false">×</button>
        </div>

        <!-- Step Progress -->
        <div class="step-progress">
          <div class="step" [class.active]="currentAcceptanceStep >= 1" [class.completed]="currentAcceptanceStep > 1">
            <span class="step-number">1</span>
            <span class="step-label">Review Bid</span>
          </div>
          <div class="step" [class.active]="currentAcceptanceStep >= 2" [class.completed]="currentAcceptanceStep > 2">
            <span class="step-number">2</span>
            <span class="step-label">Shipping Calculator</span>
          </div>
          <div class="step" [class.active]="currentAcceptanceStep >= 3" [class.completed]="currentAcceptanceStep > 3">
            <span class="step-number">3</span>
            <span class="step-label">Order Confirmation</span>
          </div>
          <div class="step" [class.active]="currentAcceptanceStep >= 4" [class.completed]="currentAcceptanceStep > 4">
            <span class="step-number">4</span>
            <span class="step-label">Complete</span>
          </div>
        </div>

        <!-- Step 1: Review Bid -->
        <div class="step-content" *ngIf="currentAcceptanceStep === 1">
          <h3>📋 Review Bid Details</h3>
          <div class="bid-review" *ngIf="selectedBidForAcceptance && selectedListingForAcceptance">
            <div class="bid-info">
              <h4>Bid Information</h4>
              <p><strong>Bidder:</strong> {{ selectedBidForAcceptance.bidderName }}</p>
              <p><strong>Amount:</strong> ${{ selectedBidForAcceptance.amount.toLocaleString() }}</p>
              <p><strong>Time:</strong> {{ selectedBidForAcceptance.timestamp | date:'medium' }}</p>
            </div>
            <div class="listing-info">
              <h4>Listing Information</h4>
              <p><strong>Watch:</strong> {{ selectedListingForAcceptance.title }}</p>
              <p><strong>Starting Price:</strong> ${{ selectedListingForAcceptance.startingPrice.toLocaleString() }}</p>
              <p><strong>Final Sale Price:</strong> ${{ selectedBidForAcceptance.amount.toLocaleString() }}</p>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn-primary" (click)="nextAcceptanceStep()">Continue to Shipping Calculator</button>
          </div>
        </div>

        <!-- Step 2: Shipping Calculator -->
        <div class="step-content" *ngIf="currentAcceptanceStep === 2">
          <h3>🚚 Calculate Shipping Costs</h3>
          <p>Calculate shipping costs to determine final order details.</p>
          <app-shipping-calculator></app-shipping-calculator>
          <div class="step-actions">
            <button class="btn-secondary" (click)="previousAcceptanceStep()">Back to Review</button>
            <button class="btn-primary" (click)="nextAcceptanceStep()">Continue to Confirmation</button>
          </div>
        </div>

        <!-- Step 3: Order Confirmation -->
        <div class="step-content" *ngIf="currentAcceptanceStep === 3">
          <h3>✅ Confirm Order Details</h3>
          <div class="order-summary" *ngIf="selectedBidForAcceptance && selectedListingForAcceptance">
            <h4>Order Summary</h4>
            <div class="summary-row">
              <span>Watch Price:</span>
              <span>${{ selectedBidForAcceptance.amount.toLocaleString() }}</span>
            </div>
            <div class="summary-row">
              <span>Shipping Cost:</span>
              <span>To be calculated</span>
            </div>
            <div class="summary-row total">
              <span>Total:</span>
              <span>${{ selectedBidForAcceptance.amount.toLocaleString() }} + Shipping</span>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn-secondary" (click)="previousAcceptanceStep()">Back to Shipping</button>
            <button class="btn-primary" (click)="nextAcceptanceStep()">Continue to Complete</button>
          </div>
        </div>

        <!-- Step 4: Complete -->
        <div class="step-content" *ngIf="currentAcceptanceStep === 4">
          <h3>🎉 Complete Order Creation</h3>
          <p>Review all details and complete the order creation process.</p>
          <div class="final-confirmation">
            <p><strong>Ready to create order?</strong></p>
            <p>This will:</p>
            <ul>
              <li>Accept the bid</li>
              <li>Create an order</li>
              <li>Mark the listing as sold</li>
              <li>Begin the verification process</li>
            </ul>
          </div>
          <div class="step-actions">
            <button class="btn-secondary" (click)="previousAcceptanceStep()">Back to Confirmation</button>
            <button class="btn-success" (click)="completeBidAcceptance()">Complete Order Creation</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>